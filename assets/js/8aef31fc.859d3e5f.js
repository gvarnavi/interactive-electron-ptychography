"use strict";(self.webpackChunkinteractive_ptycho=self.webpackChunkinteractive_ptycho||[]).push([[4170],{75221:(e,t,i)=>{i.r(t),i.d(t,{assets:()=>fe,contentTitle:()=>pe,default:()=>me,frontMatter:()=>ce,metadata:()=>de,toc:()=>_e});var n=i(85893),a=i(11151),r=i(67294),l=i(57940);function o(e){return e`# Ptychography Helper Functions`}function s(e){return e.html`<hr class="hideable-md">`}function u(e){return e("https://cdn.jsdelivr.net/gh/nicolaspanel/numjs@0.16/dist/numjs.min.js")}function c(e){return e("https://bundle.run/ndarray-ops@1.2.2")}function p(e){return e("https://bundle.run/ndarray-complex@1.0.3")}function d(e,t){return function(i,n){let a=e.zeros(i.shape);return t.atan2(a.selection,i.selection,n.selection),a}}function f(e,t){return function(i,n){let a=e.zeros(i.shape);return t.lts(a.selection,i.selection,n),t.bandseq(a.selection,1),a}}function _(e,t,i){return class n{constructor(t){this.shape=t;let i=t.slice();i.push(2),this.data=e.zeros(i),this._nulls=new Array(t.length).fill(null)}re(){return this.data.pick(...this._nulls,0)}im(){return this.data.pick(...this._nulls,1)}abs(){return e.sqrt(this.abs_sqr())}abs_sqr(){return e.add(this.re().multiply(this.re()),this.im().multiply(this.im()))}angle(){return t(this.im(),this.re())}clone(){let e=new n(this.shape);return e.data=this.data.clone(),e}conjugate(){let t=this.re().clone(),a=this.im().clone();i.conjeq(t.selection,a.selection);let r=new n(this.shape);return r.data=e.stack([t,a],-1),r}multiply(t){let a=this.re().clone(),r=this.im().clone(),l=t.re(),o=t.im();i.muleq(a.selection,r.selection,l.selection,o.selection);let s=new n(this.shape);return s.data=e.stack([a,r],-1),s}real_multiply(t){let a=this.re().clone(),r=this.im().clone(),l=t,o=e.zeros(t.shape);i.muleq(a.selection,r.selection,l.selection,o.selection);let s=new n(this.shape);return s.data=e.stack([a,r],-1),s}scalar_multiply(t,a){let r=this.re().clone(),l=this.im().clone();i.mulseq(r.selection,l.selection,t,a);let o=new n(this.shape);return o.data=e.stack([r,l],-1),o}add(t){let a=this.re().clone(),r=this.im().clone(),l=t.re(),o=t.im();i.addeq(a.selection,r.selection,l.selection,o.selection);let s=new n(this.shape);return s.data=e.stack([a,r],-1),s}subtract(t){let a=this.re().clone(),r=this.im().clone(),l=t.re(),o=t.im();i.subeq(a.selection,r.selection,l.selection,o.selection);let s=new n(this.shape);return s.data=e.stack([a,r],-1),s}}}function h(e){return function(t,i){let n=e.zeros(t),a=1/(t*i),r=1+((t-1)/2|0);for(var l=0;l<r;l++)n.set(l,l*a);for(l=r;l<t;l++)n.set(l,(l-t)*a);return n}}function m(e){return function(t,i){let n=[t.size,i.size],a=[];a[0]=e.zeros(n),a[1]=e.zeros(n);for(let e=0;e<n[1];e++)for(let r=0;r<n[0];r++)a[0].set(r,e,t.get(r)),a[1].set(r,e,i.get(e));return a}}function b(e){return function(t){let[i,n]=t.shape,a=i/2|0,r=n/2|0,l=e.zeros([i,n]);return l.slice([null,a],[null,r]).assign(t.slice(-a,-r),!1),l.slice([null,a],r).assign(t.slice(-a,[null,r]),!1),l.slice(-a,-r).assign(t.slice([null,a],[null,r]),!1),l.slice(-a,[null,r]).assign(t.slice([null,a],-r),!1),l}}function g(e,t,i,n){return function(a,r){let[l,o]=a.shape,[s,u]=r,c=new e([l,o]);c.data=t.fft(a.data);let p=i(l,1),d=i(o,1),[f,_]=n(p,d),h=-2*Math.PI,m=t.add(f.multiply(s),_.multiply(u)).multiply(h),b=new e([l,o]),g=t.cos(m),v=t.sin(m);b.data=t.stack([g,v],-1);let y=c.multiply(b);return y.data=t.ifft(y.data),y}}function v(e,t,i,n){return function(a,r){let[l,o]=a.shape,[s,u]=r,c=new e([l,o]);c.data=t.fft(a.data);let p=i(l,1),d=i(o,1),[f,_]=n(p,d),h=-2*Math.PI,m=t.add(f.multiply(s),_.multiply(u)).multiply(h),b=new e([l,o]),g=t.cos(m),v=t.sin(m);b.data=t.stack([g,v],-1);let y=c.multiply(b),w=new e([l,o]);return w.data=t.ifft(y.data),[y,w]}}function y(e){return function(t,[i,n]){let a=new e([i,n]),r=i/2|0,l=n/2|0;return a.data.slice([null,r],[null,l],null).assign(t.slice([null,r],[null,l],null),!1),a.data.slice(-r,[null,l],null).assign(t.slice(-r,[null,l],null),!1),a.data.slice([null,r],-l,null).assign(t.slice([null,r],-l,null),!1),a.data.slice(-r,-l,null).assign(t.slice(-r,-l,null),!1),a}}function w(e,t,i){return function(n,a){let[r,l]=n.shape;console.log(r);let o=new e([r,l]);o.data=t.fft(n.data);let[s,u]=[r/a|0,l/a|0],c=i(o.data,[s,u]);return c.data=t.ifft(c.data),c}}function x(){return function(e){let t=9.109383*1e-30,i=1602177e-24,n=299792458;return 662607e-39/Math.sqrt(2*t*i*e)/Math.sqrt(1+i*e/2/t/n/n)*1e11}}function z(e){return function(t){let i=9.109383*1e-30,n=1602177e-24,a=299792458,r=e(t);return 2*Math.PI/r/t*(i*a*a+n*t)/(2*i*a*a+n*t)}}function k(e,t,i,n,a,r,l){return class{constructor(t,i,n,a,r,l=0,o=Math.PI/2){this._gpts=t.slice(),this._sampling=i.slice(),this._energy=n,this._wavelength=e(n),this._semiangle_cutoff=a,this._defocus=r,this._stig=l,this._stig_angle=o}_get_scattering_angles(){let e=t(this._gpts[0],this._sampling[0]),r=t(this._gpts[1],this._sampling[1]),[l,o]=i(e,r);return[n.sqrt(n.add(l.multiply(l.multiply(this._wavelength*this._wavelength)),o.multiply(o.multiply(this._wavelength*this._wavelength)))),a(o,l)]}_evaluate_aberrations(e,t){let i=Math.PI/this._wavelength,a=n.cos(t.subtract(this._stig_angle).multiply(2)).multiply(this._stig).add(this._defocus),l=e.multiply(e).multiply(a).multiply(i),o=n.cos(l),s=n.sin(l),u=new r(l.shape);return u.data=n.stack([o,s],-1),u}_evaluate_aperture(e,t){let i=this._semiangle_cutoff/1e3,a=new r(e.shape),o=l(e,i);return a.data=n.stack([o,n.zeros(e.shape)],-1),a}build(){let[e,t]=this._get_scattering_angles(),i=this._evaluate_aberrations(e,t),a=this._evaluate_aperture(e,t),l=i.multiply(a),o=new r(l.shape);o.data=n.ifft(l.data);let s=Math.sqrt(o.abs_sqr().sum());return this._array=o.scalar_multiply(1/s,0),this._fourier_array=l,this._aberrations=i,this._aperture=a,this}}}function j(e){return e`https://observablehq.com/@mootari/notebook-data`}function D(e,t){const i=e.module();return i.variable(t()).define(["md"],o),i.variable(t()).define(["htl"],s),i.variable(t("nj")).define("nj",["require"],u),i.variable(t("ops")).define("ops",["require"],c),i.variable(t("cops")).define("cops",["require"],p),i.variable(t("atan2")).define("atan2",["nj","ops"],d),i.variable(t("lt_int_s")).define("lt_int_s",["nj","ops"],f),i.variable(t("ComplexNDArray")).define("ComplexNDArray",["nj","atan2","cops"],_),i.variable(t("fftfreq")).define("fftfreq",["nj"],h),i.variable(t("meshgrid2D")).define("meshgrid2D",["nj"],m),i.variable(t("fftshift2D")).define("fftshift2D",["nj"],b),i.variable(t("fourier_shift")).define("fourier_shift",["ComplexNDArray","nj","fftfreq","meshgrid2D"],g),i.variable(t("fourier_shift_extended")).define("fourier_shift_extended",["ComplexNDArray","nj","fftfreq","meshgrid2D"],v),i.variable(t("corner_crop")).define("corner_crop",["ComplexNDArray"],y),i.variable(t("fourier_downsample")).define("fourier_downsample",["ComplexNDArray","nj","corner_crop"],w),i.variable(t("electron_wavelength_angstroms")).define("electron_wavelength_angstroms",x),i.variable(t("electron_interaction_parameter")).define("electron_interaction_parameter",["electron_wavelength_angstroms"],z),i.variable(t("ComplexProbe")).define("ComplexProbe",["electron_wavelength_angstroms","fftfreq","meshgrid2D","nj","atan2","ComplexNDArray","lt_int_s"],k),i.variable(t()).define(["md"],j),i}function q(e){return e`# 4DSTEM Multislice Simulation

Below we simulate the diffraction intensity for an fcc-like material made of 7 [111] atomic layers, using the multislice algorithm.  

First, move your mouse around the potential to move the probe around.`}function M(e,t,i,n,a,r,l){let o=[];return e.visualization_checkboxes.includes("potential")&&(o=[...o,t]),e.visualization_checkboxes.includes("probe")&&(o=[...o,i]),e.visualization_checkboxes.includes("diffraction")&&(o=[...o,n]),a`<div style="display:flex; flex-wrap: wrap;">

${o.map((e=>r.legend({width:l.width,marginLeft:10,marginRight:10,label:e.label,color:{domain:e.domain,scheme:e.scheme,type:e.type,exponent:e.exponent,style:{background:"none"}}})))}`}function C(e,t,i,n,a,r,l,o,s,u,c){let p=10,d=[];e.visualization_checkboxes.includes("potential")&&(d=[...d,t]),e.visualization_checkboxes.includes("probe")&&(d=[...d,i]),e.visualization_checkboxes.includes("diffraction")&&(d=[...d,n]);let f=d.length,_=a.width*f,h=a.width/r[0]*r[1];return l.plot({width:_,height:h-20,padding:0,margin:0,x:{axis:null,range:[0,_]},y:{axis:null,range:[0,h]},marks:[l.cell(o.cross(o.range(f),[0]).map((([e,t])=>({a:e,b:t}))),{x:"a",y:"b",render:(e,{x:t,y:i},{x:n,y:a,channels:{x:{value:r},y:{value:l}}})=>o.create("svg:g").call((l=>l.selectAll().data(e).join("g").attr("transform",(e=>`translate(${n[e]+p},${a[e]})`)).append((e=>s(d,r[e],t.bandwidth()-20,i.bandwidth()-20))))).on("pointerenter pointermove",(e=>{let n=u(o.pointer(e),[p,0],[t.bandwidth()-20,i.bandwidth()-20]);null!==n&&(c.value=[n[0],n[1]])})).node()})]})}function P(e){return e`Once you get a feel for our mode of interaction, turn on the "diffraction" visualization panel to perform a multislice simulation at that probe position.

(Be please be patient, this is running client-side in your browser ðŸ˜¬)`}function A(e){return e.form({visualization_checkboxes:e.checkbox(["potential","probe","diffraction"],{value:["potential","probe"],label:"panels"}),use_multislice:e.toggle({label:"use multislice?",value:!1})})}function I(e){return e`Finally, play around with the defocus, convergence angle, and energy to see how the diffraction intensities change! You can also toggle the multislice formalism on/off to see how crude of an approximation the "single-slice" approximation is for a sample this thin.`}function N(e){return e`#### Simulation Parameters`}function S(e){return e.form({defocus:e.range([-250,250],{value:150,step:1,label:"defocus, \xc5"}),semiangle:e.range([5,30],{value:25,step:.5,label:"semiangle, mrad"}),width:e.range([100,500],{value:265,step:1,label:"width"})})}function F(e){return e.html`<hr class="hideable-md">`}async function E(e,t){let i=new Float32Array(await e("FCC-slab-potential-7x244x242-float32.npy").arrayBuffer()),n=Array.from(i),a=t.zeros([7,244,242]);return a.selection.data=n,a}function T(e,t,i){let n=e(1e3*t)/e(8e4);return i.multiply(n)}function V(e,t){return{label:"Projected Electrostatic Potential (rad)",domain:[0,Math.PI],scheme:"Purples",width:e.shape[2],height:e.shape[1],values:t.flatten().tolist()}}function G(e,t){let[i,n,a]=e.shape,r=t.zeros([n,a]);for(let l=0;l<i;l++){let t=e.pick(l,null,null);r=r.add(t)}return r}function R(e,t,i,n){let[a,r,l]=e.shape;return[...Array(a+1)].map(((o,s)=>{if(s<a){let n=new t([r,l]),a=e.pick(s,null,null),o=i.cos(a),u=i.sin(a);return n.data=i.stack([o,u],-1),n}{let e=new t([r,l]),a=i.cos(n),o=i.sin(n);return e.data=i.stack([a,o],-1),e}}))}function B(){return[.1,.1]}function $(e){return[e.shape[1],e.shape[2]]}function L(){return 80}function X(e,t,i,n,a){return new e(t,i,1e3*n,a.semiangle,a.defocus).build()}function H(e,t,i,n){if(e.visualization_checkboxes.includes("probe")){let e=t(i._array,[n[1],-n[0]]).abs_sqr();return{label:"Illuminating Probe Intensity",scheme:"Greys",domain:[0,i._array.abs_sqr().max()],width:e.shape[1],height:e.shape[0],values:e.flatten().tolist()}}}function O(e,t,i,n,a){return function(r,l,o,s){let u=e(o)*Math.PI*s,c=t(r[0],l[0]),p=t(r[1],l[1]),[d,f]=i(c,p),_=n.add(d.multiply(d),f.multiply(f)).multiply(u),h=n.cos(_),m=n.sin(_),b=new a(r);return b.data=n.stack([h,m],-1),b}}function U(e,t){return function(i,n){let a=new e(i.shape);return a.data=t.fft(i.data),a.data=t.ifft(a.multiply(n).data),a}}function W(e,t,i){return function(n,a){let[r,l,o]=n.shape,s=a.clone();for(let u=0;u<r;u++)s=s.multiply(e[u]),u+1<r&&(s=t(s,i));return s}}function Y(e){return function(t,i){let n=i.clone();return n=n.multiply(e[t.shape[0]]),n}}function J(e,t,i,n,a,r){return function(l,o,[s,u]){let c=(e.use_multislice?t:i)(l,o),p=new n(c.shape);return p.data=a.fft(c.data),r(p.data,[s,u]).abs_sqr()}}function K(e,t,i,n){return e(t,i,1e3*n,20/7)}function Q(e,t,i,n,a,r,l,o){if(e.visualization_checkboxes.includes("diffraction")){let e=o(t(i,n(a._array,[r[1],r[0]]),l));return{label:"Diffraction Intensities",scheme:"Magma",domain:[0,150],type:"pow",exponent:.5,width:e.shape[1],height:e.shape[0],values:e.flatten().tolist()}}}function Z(e){return[e[0]/2,e[1]/2]}function ee(e){return(t,i,n,a)=>e.plot({width:n,height:a,margin:0,x:{axis:null},y:{axis:null},color:{label:t[i].label,domain:t[i].domain,scheme:t[i].scheme,type:t[i].type,exponent:t[i].exponent,style:{background:"none"}},style:{background:"none"},marks:[e.raster(t[i].values,{width:t[i].width,height:t[i].height}),e.frame({strokeWidth:1})]})}function te(e){return function([t,i],[n,a],[r,l]){let[o,s]=[(t-n)/r,(i-a)/l];return o>1?null:[o*e[0],s*e[1]]}}function ie(e,t){const n=e.module();const a=new Map([["FCC-slab-potential-7x244x242-float32.npy",{url:new URL(i(84323),i.b),mimeType:"application/octet-stream",toString:function(){return this.url}}]]);n.builtin("FileAttachment",e.fileAttachments((e=>a.get(e)))),n.variable(t()).define(["md"],q),n.variable(t("visualization_legends")).define("visualization_legends",["viz_inputs_a","potential_dictionary","probe_dictionary","dp_dictionary","html","Plot","viz_inputs_b"],M),n.variable(t("main_visualization")).define("main_visualization",["viz_inputs_a","potential_dictionary","probe_dictionary","dp_dictionary","viz_inputs_b","gpts","Plot","d3","raster_subplot","left_panel_pixels_to_pos","mutable probe_xy"],C),n.variable(t()).define(["md"],P),n.variable(t("viewof viz_inputs_a")).define("viewof viz_inputs_a",["Inputs"],A),n.variable(t("viz_inputs_a")).define("viz_inputs_a",["Generators","viewof viz_inputs_a"],((e,t)=>e.input(t))),n.variable(t()).define(["md"],I),n.variable(t()).define(["md"],N),n.variable(t("viewof viz_inputs_b")).define("viewof viz_inputs_b",["Inputs"],S),n.variable(t("viz_inputs_b")).define("viz_inputs_b",["Generators","viewof viz_inputs_b"],((e,t)=>e.input(t))),n.variable(t()).define(["htl"],F);const r=e.module(D);return n.import("nj",r),n.import("ComplexNDArray",r),n.import("fftfreq",r),n.import("fftshift2D",r),n.import("corner_crop",r),n.import("meshgrid2D",r),n.import("fourier_shift",r),n.import("ComplexProbe",r),n.import("electron_wavelength_angstroms",r),n.import("electron_interaction_parameter",r),n.variable(t("potential_raw")).define("potential_raw",["FileAttachment","nj"],E),n.variable(t("potential")).define("potential",["electron_interaction_parameter","energy_keV","potential_raw"],T),n.variable(t("potential_dictionary")).define("potential_dictionary",["potential","projected_potential"],V),n.variable(t("projected_potential")).define("projected_potential",["potential","nj"],G),n.variable(t("complex_potentials")).define("complex_potentials",["potential","ComplexNDArray","nj","projected_potential"],R),n.variable(t("sampling")).define("sampling",B),n.variable(t("gpts")).define("gpts",["potential"],$),n.variable(t("energy_keV")).define("energy_keV",L),n.variable(t("real_space_probe")).define("real_space_probe",["ComplexProbe","gpts","sampling","energy_keV","viz_inputs_b"],X),n.variable(t("probe_dictionary")).define("probe_dictionary",["viz_inputs_a","fourier_shift","real_space_probe","probe_xy"],H),n.variable(t("propagator_array")).define("propagator_array",["electron_wavelength_angstroms","fftfreq","meshgrid2D","nj","ComplexNDArray"],O),n.variable(t("propagate_wavefunction")).define("propagate_wavefunction",["ComplexNDArray","nj"],U),n.variable(t("multislice_propagation")).define("multislice_propagation",["complex_potentials","propagate_wavefunction","fixed_dz_propagator"],W),n.variable(t("singleslice_propagation")).define("singleslice_propagation",["complex_potentials"],Y),n.variable(t("diffraction_intensity")).define("diffraction_intensity",["viz_inputs_a","multislice_propagation","singleslice_propagation","ComplexNDArray","nj","corner_crop"],J),n.variable(t("fixed_dz_propagator")).define("fixed_dz_propagator",["propagator_array","gpts","sampling","energy_keV"],K),n.variable(t("dp_dictionary")).define("dp_dictionary",["viz_inputs_a","diffraction_intensity","potential","fourier_shift","real_space_probe","probe_xy","gpts","fftshift2D"],Q),n.define("initial probe_xy",["gpts"],Z),n.variable(t("mutable probe_xy")).define("mutable probe_xy",["Mutable","initial probe_xy"],((e,t)=>new e(t))),n.variable(t("probe_xy")).define("probe_xy",["mutable probe_xy"],(e=>e.generator)),n.variable(t("raster_subplot")).define("raster_subplot",["Plot"],ee),n.variable(t("left_panel_pixels_to_pos")).define("left_panel_pixels_to_pos",["gpts"],te),n}function ne(e){return e}function ae(e){return e}function re(e){return e}function le(e){return e}function oe(e){return e.html`<hr class="hideable-md" >`}function se(e,t){const i=e.module();i.variable(t()).define(["visualization_legends"],ne),i.variable(t()).define(["main_visualization"],ae),i.variable(t()).define(["viewof viz_inputs_a"],re),i.variable(t()).define(["viewof viz_inputs_b"],le),i.variable(t()).define(["htl"],oe);const n=e.module(ie);return i.import("mutable probe_xy",n),i.import("probe_xy",n),i.import("main_visualization",n),i.import("visualization_legends",n),i.import("viewof viz_inputs_a",n),i.import("viz_inputs_a",n),i.import("viewof viz_inputs_b",n),i.import("viz_inputs_b",n),i}const ue=function(){const e=(0,r.useRef)();return(0,r.useEffect)((()=>{const t=new l.Runtime;return t.module(se,l.Inspector.into(e.current)),()=>t.dispose()}),[]),(0,n.jsx)(n.Fragment,{children:(0,n.jsx)("div",{ref:e})})},ce={id:"4dstem-intro",sidebar_position:1,title:"4DSTEM Introduction",hide_table_of_contents:!0,hide_title:!0},pe=void 0,de={id:"4dstem-intro",title:"4DSTEM Introduction",description:"4D Scanning Transmission Electron Microscopy",source:"@site/slides/4dstem-intro.mdx",sourceDirName:".",slug:"/4dstem-intro",permalink:"/interactive-electron-ptychography/slides/4dstem-intro",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{id:"4dstem-intro",sidebar_position:1,title:"4DSTEM Introduction",hide_table_of_contents:!0,hide_title:!0},sidebar:"tutorialSidebar",next:{title:"Proximal Gradient Methods",permalink:"/interactive-electron-ptychography/slides/proximal-gradients"}},fe={},_e=[{value:"4D Scanning Transmission Electron Microscopy",id:"4d-scanning-transmission-electron-microscopy",level:2}];function he(e){const t={h2:"h2",...(0,a.useMDXComponents)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.h2,{id:"4d-scanning-transmission-electron-microscopy",children:"4D Scanning Transmission Electron Microscopy"}),"\n",(0,n.jsx)(ue,{})]})}function me(e={}){const{wrapper:t}={...(0,a.useMDXComponents)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(he,{...e})}):he(e)}},84323:(e,t,i)=>{e.exports=i.p+"b4465db3bc3bf3dd.bin"}}]);